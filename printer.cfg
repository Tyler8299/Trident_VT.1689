# This file contains common pin mappings for the BIGTREETECH Manta M8P V2.0
# To use this config, the firmware should be compiled for the
# STM32H723 with a "128KiB bootloader" "25 MHz crystal"
# and "USB (on PA11/PA12)", "CAN bus (on PD0/PD1)" or Serial (on USART1 PA10/PA9).

# See docs/Config_Reference.md for a description of parameters.

####################################################################
#                        KLIPPER CONFIGS                           #
####################################################################

[include KNOMI.cfg]
[include aux_fan.cfg]
[include mainsail.cfg]
[include timelapse.cfg]
[include macros.cfg]
[include BTT_2209.cfg]
[include config_backup.cfg]
[include cartographer.cfg]
[include BARF_stealthburner_leds.cfg] 
[include nevermore.cfg]  
#[include mmu/base/*.cfg]
#[include mmu/optional/client_macros.cfg]
#[include mmu/optional/client/macros*.cfg]

[exclude_object]

[force_move]
enable_force_move: True

[gcode_arcs]

####################################################################
#                        Manta MP8 CONFIGS                         #
####################################################################

[mcu]
canbus_uuid: 85562c707f72
canbus_interface: can0

[printer]
kinematics: corexy
max_velocity: 6000 
max_accel: 10000
max_z_velocity: 25        
max_z_accel: 60
minimum_cruise_ratio: 0.5             # Default 0.5
square_corner_velocity: 25            # Square corner velocity

[firmware_retraction]
retract_length: 0.75
retract_speed: 30
unretract_extra_length: 0.00
unretract_speed: 30

####################################################################
#                TEMPERATURE SENSORS & FAN CONTROL                 #
####################################################################

[temperature_sensor CB2]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_fan Electronics_Bay_1]
pin: PF7
kick_start_time: 0.5
shutdown_speed: 0
off_below: 0.1
max_power: 0.65
sensor_type: temperature_host
control: pid
min_temp: -40
max_temp: 85
pid_kp: 1.0
pid_ki: 0.5
pid_kd: 2.0
min_speed: 0.4
max_speed: 1.0
target_temp: 42

[temperature_fan Electronics_Bay_2]
pin: PF9
kick_start_time: 0.5
shutdown_speed: 0
off_below: 0.1
max_power: 0.65
sensor_type: temperature_host
control: pid
min_temp: -40
max_temp: 85
pid_kp: 1.0
pid_ki: 0.5
pid_kd: 2.0
min_speed: 0.4
max_speed: 1.0
target_temp: 42

[temperature_fan Manta_MP8]
pin: PF8
sensor_type: temperature_mcu
max_power: 1.0
shutdown_speed: 1.0
hardware_pwm: false
kick_start_time: 0.5
off_below: 0.1
max_temp: 100
min_temp: 5
target_temp: 42
max_speed: 1.0
min_speed: 0.3
control: pid
pid_Kp: 1.0
pid_Ki: 0.5
pid_Kd: 2.0

#####################################################################
#                       ADXL345 Settings                            #
#####################################################################

## Ebb 2209 2040 Sensor
[adxl345]
cs_pin: EBBCan: PB12
spi_software_sclk_pin: EBBCan: PB10
spi_software_mosi_pin: EBBCan: PB11
spi_software_miso_pin: EBBCan: PB2
axes_map: z,-y,x

[resonance_tester]
probe_points: 175, 175, 30
accel_chip: adxl345

## Cartographer Probe Sensor
#[lis2dw]
#cs_pin: cartographer:PA3
#spi_bus: spi1

#[resonance_tester]
#probe_points: 175, 175, 30
#accel_chip: lis2dw

#####################################################################
#                        X Stepper Settings                         #
#####################################################################

## Motor1
[stepper_x]
step_pin: PE6
dir_pin: !PE5
enable_pin: !PC14
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40
endstop_pin: ^EBBCan:PB6
position_endstop: 350
position_max: 350
homing_speed: 80
homing_positive_dir: True

## Motor1
[tmc5160 stepper_x]
cs_pin: PC13
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
driver_TPFD: 0 
run_current: 1.1
stealthchop_threshold: 0
spi_speed: 3500000                     # SPI speed
interpolate: True                      # Interpolation

#[autotune_tmc stepper_x]
#motor: ldo-42sth48-2504ah
#tuning_goal:performance

## Motor7
[stepper_x1]
step_pin: PD4
dir_pin: !PD3
enable_pin: !PD6
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40

## Motor7
[tmc5160 stepper_x1]
cs_pin: PD5
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
driver_TPFD: 0 
run_current: 1.1
stealthchop_threshold: 0
spi_speed: 3500000                     # SPI speed
interpolate: True                      # Interpolation

#[autotune_tmc stepper_x1]
#motor: ldo-42sth48-2504ah
#tuning_goal:performance

#####################################################################
#                        Y Stepper Settings                         #
#####################################################################

## Motor8
[stepper_y]
step_pin: PC7
dir_pin: !PC8
enable_pin: !PD2
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40
endstop_pin: ^PF4
position_endstop: 350
position_max: 350
homing_speed: 80
homing_positive_dir: True

## Motor8
[tmc5160 stepper_y]
cs_pin: PC6
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
driver_TPFD: 0 
run_current: 1.1
stealthchop_threshold: 0
spi_speed: 3500000                     # SPI speed
interpolate: True                      # Interpolation

#[autotune_tmc stepper_y]
#motor: ldo-42sth48-2504ah
#tuning_goal:performance

## Motor2
[stepper_y1]
step_pin: PE2
dir_pin: !PE1
enable_pin: !PE4
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40

## Motor2
[tmc5160 stepper_y1]
cs_pin: PE3
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
driver_TPFD: 0 
run_current: 1.1
stealthchop_threshold: 0
spi_speed: 3500000                     # SPI speed
interpolate: True                      # Interpolation

#[autotune_tmc stepper_y1]
#motor: ldo-42sth48-2504ah
#tuning_goal:performance

#####################################################################
##                        Z Stepper Settings                        #
#####################################################################

#    -------z1------- 
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#  z0---   display ---z2

## Motor3
[stepper_z]
step_pin: PB8
dir_pin: !PB7
enable_pin: !PE0
rotation_distance: 4    
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop 
position_max: 243
position_min: -1.5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 0
homing_positive_dir: False

## Motor3
[tmc2209 stepper_z]
uart_pin: PB9
run_current: 0.65
stealthchop_threshold: 0

## Motor4
[stepper_z1]
step_pin: PB4
dir_pin: !PB3
enable_pin: !PB6
microsteps: 32
rotation_distance: 4

## Motor4
[tmc2209 stepper_z1]
uart_pin: PB5
run_current: 0.65
stealthchop_threshold: 0

## Motor5
[stepper_z2]
step_pin: PG13
dir_pin: !PG12
enable_pin: !PG15
microsteps: 32
rotation_distance: 4

## Motor5
[tmc2209 stepper_z2]
uart_pin: PG14
run_current: 0.65
stealthchop_threshold: 0

#####################################################################
#                          Bed Heater                               #
#####################################################################

[idle_timeout]
timeout: 1800

[heater_bed]
heater_pin: PA1
sensor_pin: PB1 
sensor_type: Generic 3950
max_power: 0.6
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#             Homing and Gantry Adjustment Routines                 #
#####################################################################

[z_tilt]

z_positions:
   -50, 18
   175, 398
   400, 18
points:
   30, 5
   175, 295
   320, 5

speed: 200
horizontal_move_z: 5
retries: 5
retry_tolerance: 0.0095

[safe_z_home]

home_xy_position: 175,175
speed:100
z_hop:10

#####################################################################
#                       Probe and Bed Mesh                          #
#####################################################################

[bed_mesh]
speed: 500
horizontal_move_z: 10
probe_count: 20,20
fade_start: 1
fade_end: 10
fade_target: 0
split_delta_z: .01
move_check_distance: 3
mesh_pps: 2,2
algorithm: bicubic
mesh_min: 30,25
mesh_max: 320,325
zero_reference_position: 175,175

#####################################################################
#                            LED Control                            #
#####################################################################

## DayLight Stick
[output_pin caselight]
pin: PA3
pwm:true
hardware_pwm: False
value: 0.20 
shutdown_value: 0
value:0.40
cycle_time: 0.01

[neopixel Manta_Neo]
pin: PD15
chain_count: 8
color_order: GRBW
initial_RED: 0.2
initial_GREEN: 0.2 
initial_BLUE: 0
initial_White: 0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# pid_kp = 26.256
#*# pid_ki = 2.613
#*# pid_kd = 65.967
#*# control = pid
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 41.855
#*# pid_ki = 1.304
#*# pid_kd = 335.883
#*#
#*# [cartographer model default]
#*# model_coef = 1.4401589830955537,
#*# 	  1.8632706479950396,
#*# 	  0.7674258919745569,
#*# 	  0.3942745591165773,
#*# 	  0.26373285409435404,
#*# 	  0.13624017312005607,
#*# 	  -0.05715158480632309,
#*# 	  -0.001738439352462723,
#*# 	  0.1356439220286124,
#*# 	  0.06119025839639984
#*# model_domain = 3.1897952775989485e-07,3.285685206768639e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 42.396201
#*# model_offset = 0.40000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.029912, 0.028211, 0.015977, 0.021297, 0.031222, 0.031822, 0.041268, 0.044222, 0.048511, 0.058684, 0.066337, 0.072098, 0.064718, 0.057670, 0.064258, 0.063168, 0.059817, 0.053135, 0.025070, 0.034858
#*# 	  0.017650, 0.013494, 0.020907, 0.023535, 0.026370, 0.027371, 0.038794, 0.043190, 0.048478, 0.074740, 0.065772, 0.072103, 0.069123, 0.063850, 0.072794, 0.058640, 0.055440, 0.043209, 0.023977, 0.009363
#*# 	  -0.009306, 0.011005, 0.016231, 0.024854, 0.031055, 0.034234, 0.044819, 0.053185, 0.061190, 0.074884, 0.073401, 0.069412, 0.074593, 0.076282, 0.075293, 0.066211, 0.044843, 0.050995, 0.025504, 0.014311
#*# 	  -0.004312, 0.008113, 0.007717, 0.014609, 0.026886, 0.024436, 0.044676, 0.046865, 0.055755, 0.065513, 0.061606, 0.064631, 0.064055, 0.064261, 0.055638, 0.042922, 0.042394, 0.023445, 0.015560, -0.017222
#*# 	  -0.013474, 0.002843, 0.014715, 0.007428, 0.025978, 0.031275, 0.034113, 0.046012, 0.047584, 0.056979, 0.068573, 0.062300, 0.062961, 0.052937, 0.043975, 0.043275, 0.026697, 0.020948, -0.004362, -0.015689
#*# 	  -0.014518, -0.018743, 0.001460, -0.000902, 0.010884, 0.014805, 0.016391, 0.029256, 0.046048, 0.046549, 0.048033, 0.036842, 0.027464, 0.041904, 0.025413, 0.015259, 0.012324, -0.006782, -0.008384, -0.050862
#*# 	  -0.065438, -0.054562, -0.044095, -0.035448, -0.025250, -0.020250, -0.018971, -0.017376, -0.004408, 0.002178, 0.003648, 0.001744, -0.012370, -0.012633, -0.022689, -0.028899, -0.035588, -0.049565, -0.067678, -0.085446
#*# 	  -0.068653, -0.068900, -0.065419, -0.055826, -0.040724, -0.042485, -0.035571, -0.036932, -0.039473, -0.014609, -0.021687, -0.025445, -0.031614, -0.051177, -0.042674, -0.062137, -0.072787, -0.086788, -0.100528, -0.121000
#*# 	  -0.082564, -0.072953, -0.067998, -0.057268, -0.045524, -0.046324, -0.038361, -0.033860, -0.029299, -0.014926, -0.013691, -0.026888, -0.027312, -0.042407, -0.051215, -0.062448, -0.082248, -0.083303, -0.099517, -0.103347
#*# 	  -0.065740, -0.070913, -0.057774, -0.052771, -0.045950, -0.028127, -0.021726, -0.022370, -0.010053, -0.004167, 0.001776, -0.009085, -0.014936, -0.028902, -0.048646, -0.053482, -0.056751, -0.077961, -0.076440, -0.102978
#*# 	  -0.065923, -0.057194, -0.046669, -0.035772, -0.026268, -0.026006, -0.013353, -0.017894, -0.001847, 0.011837, 0.010649, 0.006766, 0.001433, -0.008979, -0.025226, -0.034596, -0.048379, -0.050279, -0.062685, -0.069408
#*# 	  -0.059724, -0.059841, -0.057944, -0.047494, -0.046647, -0.036772, -0.019398, -0.023358, -0.009692, -0.005955, -0.002439, 0.005123, 0.004063, -0.017236, -0.027897, -0.039191, -0.040115, -0.049106, -0.052368, -0.072920
#*# 	  -0.062975, -0.054404, -0.054779, -0.049039, -0.037067, -0.030791, -0.017543, -0.008007, -0.003962, 0.003546, 0.001468, 0.007690, 0.011284, -0.005623, -0.017727, -0.014998, -0.029919, -0.029694, -0.043948, -0.047786
#*# 	  -0.042921, -0.055658, -0.044208, -0.038197, -0.029352, -0.024084, -0.016803, -0.004715, 0.010936, 0.015389, 0.010318, 0.009750, 0.015886, 0.009534, 0.001682, -0.006086, -0.018891, -0.025338, -0.020515, -0.043982
#*# 	  -0.071038, -0.059022, -0.063071, -0.054206, -0.047024, -0.037439, -0.035394, -0.023244, -0.008436, 0.000730, 0.003940, 0.002071, -0.004006, -0.006649, -0.014529, -0.020021, -0.031513, -0.037240, -0.052866, -0.046662
#*# 	  -0.073656, -0.073938, -0.065991, -0.063018, -0.048328, -0.048015, -0.046701, -0.030961, -0.016191, -0.009740, -0.007315, -0.010028, -0.010685, -0.022972, -0.022047, -0.035821, -0.047718, -0.055062, -0.055147, -0.065924
#*# 	  -0.084431, -0.073821, -0.072010, -0.057511, -0.048735, -0.045004, -0.043290, -0.025497, -0.016290, -0.010368, -0.009484, -0.010175, -0.013039, -0.016201, -0.022064, -0.030514, -0.049427, -0.046031, -0.051421, -0.050879
#*# 	  -0.068216, -0.067333, -0.063451, -0.055179, -0.046298, -0.036083, -0.030137, -0.018299, -0.009816, -0.006022, -0.000502, 0.002553, 0.005627, -0.002355, -0.006450, -0.015125, -0.029592, -0.033563, -0.031254, -0.043150
#*# 	  -0.056129, -0.035847, -0.035380, -0.022960, -0.026401, -0.004712, -0.006937, 0.011461, 0.020286, 0.022178, 0.029017, 0.036628, 0.034975, 0.021044, 0.020465, 0.013819, 0.003944, 0.002101, 0.001315, 0.004455
#*# 	  -0.094463, -0.082590, -0.078914, -0.054171, -0.043342, -0.065405, -0.028506, -0.027852, -0.003072, -0.004506, -0.009222, 0.000462, -0.000408, -0.004572, -0.008914, -0.011101, -0.006173, -0.009913, -0.007941, -0.011881
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 320.0
#*# min_y = 25.0
#*# max_y = 325.0
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 65.2
#*# shaper_type_y = mzv
#*# shaper_freq_y = 51.2
