# This file contains common pin mappings for the BIGTREETECH Manta M8P V2.0
# To use this config, the firmware should be compiled for the
# STM32H723 with a "128KiB bootloader" "25 MHz crystal"
# and "USB (on PA11/PA12)", "CAN bus (on PD0/PD1)" or Serial (on USART1 PA10/PA9).

# See docs/Config_Reference.md for a description of parameters.

####################################################################
#                        KLIPPER CONFIGS                           #
####################################################################
[include aux_fan.cfg]
[include mainsail.cfg]
[include timelapse.cfg]
[include macros.cfg]
[include BTT_2209.cfg]
[include config_backup.cfg]
[include cartographer.cfg]
[include stealthburner_leds.cfg] 
[include nevermore.cfg]  
#[include mmu/base/*.cfg]
#[include mmu/optional/client_macros.cfg]
#[include mmu/optional/client/macros*.cfg]

[exclude_object]

[force_move]
enable_force_move: True

[gcode_arcs]
resolution: 0.1

####################################################################
#                        Manta MP8 CONFIGS                         #
####################################################################

[mcu]
canbus_uuid: 85562c707f72
canbus_interface: can0

[printer]
kinematics: corexy
max_velocity: 6000 
max_accel: 10000
max_z_velocity: 25        
max_z_accel: 60
minimum_cruise_ratio: 0.5             # Default 0.5
square_corner_velocity: 25            # Square corner velocity

[firmware_retraction]
retract_length: 0.75
retract_speed: 30
unretract_extra_length: 0.00
unretract_speed: 30

####################################################################
#                TEMPERATURE SENSORS & FAN CONTROL                 #
####################################################################

[temperature_sensor CB2]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_fan Electronics_Bay_1]
pin: PF7
kick_start_time: 0.5
shutdown_speed: 0
off_below: 0.1
max_power: 0.65
sensor_type: temperature_host
control: pid
min_temp: -40
max_temp: 85
pid_kp: 1.0
pid_ki: 0.5
pid_kd: 2.0
min_speed: 0.4
max_speed: 1.0
target_temp: 42

[temperature_fan Electronics_Bay_2]
pin: PF9
kick_start_time: 0.5
shutdown_speed: 0
off_below: 0.1
max_power: 0.65
sensor_type: temperature_host
control: pid
min_temp: -40
max_temp: 85
pid_kp: 1.0
pid_ki: 0.5
pid_kd: 2.0
min_speed: 0.4
max_speed: 1.0
target_temp: 42

[temperature_fan Manta_MP8]
pin: PF8
sensor_type: temperature_mcu
max_power: 1.0
shutdown_speed: 1.0
hardware_pwm: false
kick_start_time: 0.5
off_below: 0.1
max_temp: 100
min_temp: 5
target_temp: 42
max_speed: 1.0
min_speed: 0.3
control: pid
pid_Kp: 1.0
pid_Ki: 0.5
pid_Kd: 2.0

#####################################################################
#                       ADXL345 Settings                            #
#####################################################################

## Ebb 2209 2040 Sensor
[adxl345]
cs_pin: EBBCan: PB12
spi_software_sclk_pin: EBBCan: PB10
spi_software_mosi_pin: EBBCan: PB11
spi_software_miso_pin: EBBCan: PB2
axes_map: z,-y,x

[resonance_tester]
probe_points: 175, 175, 30
accel_chip: adxl345

## Cartographer Probe Sensor
#[lis2dw]
#cs_pin: cartographer:PA3
#spi_bus: spi1

#[resonance_tester]
#probe_points: 175, 175, 30
#accel_chip: lis2dw

#####################################################################
#                        X Stepper Settings                         #
#####################################################################

## Motor1
[stepper_x]
step_pin: PE6
dir_pin: !PE5
enable_pin: !PC14
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40
endstop_pin: ^EBBCan:PB6
position_endstop: 350
position_max: 350
homing_speed: 80
homing_positive_dir: True

## Motor1
[tmc5160 stepper_x]
cs_pin: PC13
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
driver_TPFD: 0 
run_current: 0.95
stealthchop_threshold: 0
spi_speed: 3500000                    # SPI speed
interpolate: True                     # Interpolation

[autotune_tmc stepper_x]
motor: ldo-42sth48-2504ah
tuning_goal:performance

## Motor7
[stepper_x1]
step_pin: PD4
dir_pin: !PD3
enable_pin: !PD6
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40

## Motor7
[tmc5160 stepper_x1]
cs_pin: PD5
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
driver_TPFD: 0 
run_current: 0.95
stealthchop_threshold: 0
spi_speed: 3500000                    # SPI speed
interpolate: True                     # Interpolation

[autotune_tmc stepper_x1]
motor: ldo-42sth48-2504ah
tuning_goal:performance

#####################################################################
#                        Y Stepper Settings                         #
#####################################################################

## Motor8
[stepper_y]
step_pin: PC7
dir_pin: !PC8
enable_pin: !PD2
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40
endstop_pin: ^PF4
position_endstop: 350
position_max: 350
homing_speed: 80
homing_positive_dir: True

## Motor8
[tmc5160 stepper_y]
cs_pin: PC6
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
driver_TPFD: 0 
run_current: 0.95
stealthchop_threshold: 0
spi_speed: 3500000                    # SPI speed
interpolate: True                     # Interpolation

[autotune_tmc stepper_y]
motor: ldo-42sth48-2504ah
tuning_goal:performance

## Motor2
[stepper_y1]
step_pin: PE2
dir_pin: !PE1
enable_pin: !PE4
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40

## Motor2
[tmc5160 stepper_y1]
cs_pin: PE3
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
driver_TPFD: 0 
run_current: 0.95
stealthchop_threshold: 0
spi_speed: 3500000                    # SPI speed
interpolate: True                     # Interpolation

[autotune_tmc stepper_y1]
motor: ldo-42sth48-2504ah
tuning_goal:performance

#####################################################################
##                        Z Stepper Settings                        #
#####################################################################

#    -------z1------- 
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#  z0---   display ---z2

## Motor3
[stepper_z]
step_pin: PB8
dir_pin: !PB7
enable_pin: !PE0
rotation_distance: 4    
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop 
position_max: 243
position_min: -.5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 0
homing_positive_dir: False

## Motor3
[tmc2209 stepper_z]
uart_pin: PB9
run_current: 0.65
stealthchop_threshold: 0

## Motor4
[stepper_z1]
step_pin: PB4
dir_pin: !PB3
enable_pin: !PB6
microsteps: 32
rotation_distance: 4

## Motor4
[tmc2209 stepper_z1]
uart_pin: PB5
run_current: 0.65
stealthchop_threshold: 0

## Motor5
[stepper_z2]
step_pin: PG13
dir_pin: !PG12
enable_pin: !PG15
microsteps: 32
rotation_distance: 4

## Motor5
[tmc2209 stepper_z2]
uart_pin: PG14
run_current: 0.65
stealthchop_threshold: 0

#####################################################################
#                          Bed Heater                               #
#####################################################################

[idle_timeout]
timeout: 1800

[heater_bed]
heater_pin: PA1
sensor_pin: PB1 
sensor_type: Generic 3950
max_power: 0.6
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#             Homing and Gantry Adjustment Routines                 #
#####################################################################

[z_tilt]

z_positions:
   -50, 18
   175, 398
   400, 18
points:
   30, 5
   175, 295
   320, 5

speed: 200
horizontal_move_z: 5
retries: 5
retry_tolerance: 0.0095

[safe_z_home]

home_xy_position: 175,175
speed:100
z_hop:10

#####################################################################
#                       Probe and Bed Mesh                          #
#####################################################################

[bed_mesh]
speed: 500
horizontal_move_z: 10
probe_count: 20,20
fade_start: 1
fade_end: 10
fade_target: 0
split_delta_z: .01
move_check_distance: 3
mesh_pps: 2,2
algorithm: bicubic
mesh_min: 30,25
mesh_max: 320,325
zero_reference_position: 175,175

#####################################################################
#                            LED Control                            #
#####################################################################

## DayLight Stick
[output_pin caselight]
pin: PA3
pwm:true
hardware_pwm: False
value: 0.20 
shutdown_value: 0
value:0.40
cycle_time: 0.01

[neopixel Manta_Neo]
pin: PD15
chain_count: 8
color_order: GRBW
initial_RED: 0.2
initial_GREEN: 0.2 
initial_BLUE: 0
initial_White: 0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# pid_kp = 28.721
#*# pid_ki = 3.613
#*# pid_kd = 57.082
#*# control = pid
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 41.855
#*# pid_ki = 1.304
#*# pid_kd = 335.883
#*#
#*# [cartographer model default]
#*# model_coef = 1.4343222546392214,
#*# 	1.8572548171791756,
#*# 	0.768939290790765,
#*# 	0.3732796473211778,
#*# 	0.26089451906441596,
#*# 	0.20481540097520298,
#*# 	-0.04606379771284246,
#*# 	-0.07651605216142382,
#*# 	0.13416937160145467,
#*# 	0.09530849845613915
#*# model_domain = 3.18182621049226e-07,3.2853986125114556e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 43.934923
#*# model_offset = 0.45000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.026969, 0.022895, 0.028058, 0.030650, 0.037520, 0.043803, 0.044409, 0.051335, 0.060275, 0.066859, 0.074770, 0.075847, 0.074649, 0.070492, 0.071430, 0.070305, 0.063541, 0.054818, 0.040999, 0.029492
#*# 	0.019536, 0.024803, 0.026407, 0.032523, 0.032119, 0.041640, 0.048508, 0.048482, 0.071116, 0.074247, 0.076708, 0.076974, 0.070222, 0.082204, 0.069860, 0.063350, 0.055210, 0.042045, 0.029295, 0.005799
#*# 	0.007209, 0.021531, 0.033297, 0.038057, 0.039980, 0.051769, 0.056988, 0.064651, 0.070421, 0.078091, 0.082362, 0.076119, 0.075859, 0.082282, 0.072516, 0.066624, 0.054052, 0.044336, 0.026763, 0.001471
#*# 	0.014490, 0.021144, 0.026958, 0.031903, 0.044471, 0.049309, 0.054442, 0.061228, 0.064850, 0.072232, 0.074551, 0.062231, 0.067887, 0.066523, 0.056125, 0.049873, 0.035582, 0.024947, -0.001486, -0.025462
#*# 	0.018729, 0.029070, 0.032056, 0.036841, 0.043992, 0.050249, 0.052469, 0.059187, 0.064111, 0.070612, 0.070618, 0.066927, 0.058630, 0.056636, 0.045781, 0.035800, 0.023039, 0.003594, -0.012077, -0.035153
#*# 	0.014536, 0.021375, 0.021870, 0.024888, 0.031510, 0.039336, 0.036142, 0.047341, 0.051897, 0.050563, 0.056454, 0.041992, 0.034926, 0.029857, 0.014952, 0.008385, -0.003148, -0.015636, -0.041123, -0.067931
#*# 	-0.019068, -0.011747, -0.006118, -0.001915, 0.001281, 0.003161, 0.003046, 0.010407, 0.012501, 0.013163, 0.007051, -0.001908, -0.010880, -0.015126, -0.027275, -0.039896, -0.056244, -0.067949, -0.083300, -0.113394
#*# 	-0.020286, -0.017030, -0.022487, -0.013234, -0.009571, -0.012017, -0.009972, -0.010433, -0.005890, -0.008086, -0.015806, -0.024397, -0.033435, -0.050894, -0.052503, -0.074735, -0.090895, -0.099845, -0.121862, -0.143458
#*# 	-0.022082, -0.022189, -0.017561, -0.017551, -0.010903, -0.010797, -0.011475, -0.002069, -0.010395, -0.008487, -0.015508, -0.022994, -0.027533, -0.053582, -0.062628, -0.078936, -0.096613, -0.110910, -0.121509, -0.140751
#*# 	-0.006077, -0.006863, -0.010007, -0.004898, 0.000793, 0.000723, 0.005653, 0.009779, 0.006396, -0.001068, -0.008672, -0.008272, -0.020245, -0.040736, -0.055375, -0.073257, -0.088909, -0.102103, -0.117982, -0.139475
#*# 	0.002446, 0.004568, 0.011571, 0.012975, 0.016690, 0.015564, 0.016006, 0.022637, 0.014242, 0.016508, 0.008362, 0.001217, -0.004226, -0.028255, -0.040282, -0.058961, -0.071886, -0.086844, -0.097582, -0.118720
#*# 	0.009411, 0.007061, 0.002236, 0.006661, 0.014615, 0.010521, 0.010453, 0.012912, 0.011710, 0.006829, 0.001718, -0.000106, -0.005771, -0.030066, -0.049453, -0.058581, -0.074826, -0.086226, -0.102408, -0.124946
#*# 	0.016607, 0.015516, 0.011581, 0.012213, 0.014508, 0.014705, 0.019860, 0.020790, 0.021269, 0.012601, 0.005108, -0.000904, -0.005262, -0.024222, -0.035123, -0.047284, -0.063908, -0.083699, -0.088329, -0.109105
#*# 	0.036109, 0.031467, 0.021725, 0.020021, 0.023402, 0.021477, 0.022970, 0.027970, 0.029562, 0.019466, 0.010527, 0.003764, 0.006174, -0.013603, -0.025465, -0.039245, -0.058876, -0.069846, -0.090048, -0.109110
#*# 	0.022670, 0.023007, 0.013445, 0.008892, 0.010804, 0.008267, 0.010211, 0.015153, 0.015177, 0.010020, 0.003860, -0.007135, -0.011776, -0.028769, -0.041317, -0.058669, -0.078422, -0.095064, -0.105935, -0.118128
#*# 	0.025567, 0.021499, 0.009855, 0.009110, 0.004728, 0.008988, 0.005263, 0.006770, 0.007844, -0.002706, 0.000212, -0.016950, -0.025337, -0.042490, -0.056191, -0.069666, -0.098330, -0.108900, -0.122619, -0.137599
#*# 	0.022109, 0.019581, 0.013832, 0.012388, 0.014500, 0.009994, 0.006980, 0.010563, 0.006723, 0.000462, -0.005386, -0.018087, -0.025310, -0.041232, -0.053761, -0.071977, -0.092767, -0.112355, -0.119628, -0.133919
#*# 	0.036554, 0.032169, 0.023166, 0.022939, 0.020763, 0.017361, 0.012656, 0.014891, 0.013517, 0.004957, 0.002722, -0.006092, -0.014088, -0.029533, -0.043531, -0.062374, -0.091773, -0.098654, -0.114985, -0.129154
#*# 	0.057873, 0.060657, 0.065683, 0.052636, 0.052504, 0.049580, 0.041377, 0.045460, 0.041521, 0.034563, 0.033092, 0.028625, 0.016009, -0.006686, -0.021732, -0.038874, -0.060426, -0.072584, -0.081594, -0.092082
#*# 	0.021047, 0.050320, 0.018689, 0.031915, 0.018551, 0.013919, 0.019931, 0.019479, 0.019765, 0.003527, -0.003549, -0.006988, -0.019597, -0.036468, -0.050139, -0.062279, -0.075592, -0.086351, -0.102597, -0.111368
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 320.0
#*# min_y = 25.0
#*# max_y = 325.0
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 65.4
#*# shaper_type_y = mzv
#*# shaper_freq_y = 51.4
