# This file contains common pin mappings for the BIGTREETECH Manta M8P V2.0
# To use this config, the firmware should be compiled for the
# STM32H723 with a "128KiB bootloader" "25 MHz crystal"
# and "USB (on PA11/PA12)", "CAN bus (on PD0/PD1)" or Serial (on USART1 PA10/PA9).

# See docs/Config_Reference.md for a description of parameters.

####################################################################
#                        KLIPPER CONFIGS                           #
####################################################################
[include aux_fan.cfg]
[include mainsail.cfg]
[include timelapse.cfg]
[include macros.cfg]
[include BTT_2209.cfg]
[include config_backup.cfg]
[include cartographer.cfg]
[include stealthburner_leds.cfg] 
[include nevermore.cfg]  
#[include mmu/base/*.cfg]
#[include mmu/optional/client_macros.cfg]
#[include mmu/optional/client/macros*.cfg]

[exclude_object]

[force_move]
enable_force_move: True

[gcode_arcs]
resolution: 0.1

####################################################################
#                        Manta MP8 CONFIGS                         #
####################################################################

[mcu]
canbus_uuid: 85562c707f72
canbus_interface: can0

[printer]
kinematics: corexy
max_velocity: 6000 
max_accel: 12000
max_z_velocity: 25        
max_z_accel: 60
minimum_cruise_ratio: 0.5             # Default 0.5
square_corner_velocity: 25            # Square corner velocity

[firmware_retraction]
retract_length: 0.75
retract_speed: 30
unretract_extra_length: 0.00
unretract_speed: 30

####################################################################
#                TEMPERATURE SENSORS & FAN CONTROL                 #
####################################################################

[temperature_sensor CB2]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_fan Electronics_Bay_1]
pin: PF7
kick_start_time: 0.5
shutdown_speed: 0
off_below: 0.1
max_power: 0.8
sensor_type: temperature_host
control: pid
min_temp: -40
max_temp: 85
pid_kp: 1.0
pid_ki: 0.5
pid_kd: 2.0
min_speed: 0.4
max_speed: 1.0
target_temp: 42

[temperature_fan Electronics_Bay_2]
pin: PF9
kick_start_time: 0.5
shutdown_speed: 0
off_below: 0.1
max_power: 0.8
sensor_type: temperature_host
control: pid
min_temp: -40
max_temp: 85
pid_kp: 1.0
pid_ki: 0.5
pid_kd: 2.0
min_speed: 0.4
max_speed: 1.0
target_temp: 42

[temperature_fan Manta_MP8]
pin: PF8
sensor_type: temperature_mcu
max_power: 1.0
shutdown_speed: 1.0
hardware_pwm: false
kick_start_time: 0.5
off_below: 0.1
max_temp: 100
min_temp: 5
target_temp: 42
max_speed: 1.0
min_speed: 0.3
control: pid
pid_Kp: 1.0
pid_Ki: 0.5
pid_Kd: 2.0

#####################################################################
#                       ADXL345 Settings                            #
#####################################################################

## Ebb 2209 2040 Sensor
[adxl345]
cs_pin: EBBCan: PB12
spi_software_sclk_pin: EBBCan: PB10
spi_software_mosi_pin: EBBCan: PB11
spi_software_miso_pin: EBBCan: PB2
axes_map: z,-y,x

[resonance_tester]
probe_points: 175, 175, 30
accel_chip: adxl345

## Cartographer Probe Sensor
#[lis2dw]
#cs_pin: cartographer:PA3
#spi_bus: spi1

#[resonance_tester]
#probe_points: 175, 175, 30
#accel_chip: lis2dw

#####################################################################
#                        X Stepper Settings                         #
#####################################################################

## Motor1
[stepper_x]
step_pin: PE6
dir_pin: !PE5
enable_pin: !PC14
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40
endstop_pin: ^EBBCan:PB6
position_endstop: 350
position_max: 350
homing_speed: 80
homing_positive_dir: True

## Motor1
[tmc5160 stepper_x]
cs_pin: PC13
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
run_current: 0.85
stealthchop_threshold: 0
spi_speed: 3500000                    # SPI speed
interpolate: False                     # Interpolation

## Motor7
[stepper_x1]
step_pin: PD4
dir_pin: !PD3
enable_pin: !PD6
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40

## Motor7
[tmc5160 stepper_x1]
cs_pin: PD5
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
run_current: 0.85
stealthchop_threshold: 0
spi_speed: 3500000                    # SPI speed
interpolate: False                     # Interpolation

#####################################################################
#                        Y Stepper Settings                         #
#####################################################################

## Motor8
[stepper_y]
step_pin: PC7
dir_pin: !PC8
enable_pin: !PD2
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40
endstop_pin: ^PF4
position_endstop: 350
position_max: 350
homing_speed: 80
homing_positive_dir: True

## Motor8
[tmc5160 stepper_y]
cs_pin: PC6
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
run_current: 0.85
stealthchop_threshold: 0
spi_speed: 3500000                    # SPI speed
interpolate: False                     # Interpolation

## Motor2
[stepper_y1]
step_pin: PE2
dir_pin: !PE1
enable_pin: !PE4
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40

## Motor2
[tmc5160 stepper_y1]
cs_pin: PE3
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
run_current: 0.85
stealthchop_threshold: 0
spi_speed: 3500000                    # SPI speed
interpolate: False                     # Interpolation

#####################################################################
##                        Z Stepper Settings                        #
#####################################################################

#    -------z1------- 
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#  z0---   display ---z2

## Motor3
[stepper_z]
step_pin: PB8
dir_pin: !PB7
enable_pin: !PE0
rotation_distance: 4    
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop 
position_max: 243
position_min: -.5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 0
homing_positive_dir: False

## Motor3
[tmc2209 stepper_z]
uart_pin: PB9
run_current: 0.65
stealthchop_threshold: 0

## Motor4
[stepper_z1]
step_pin: PB4
dir_pin: !PB3
enable_pin: !PB6
microsteps: 32
rotation_distance: 4

## Motor4
[tmc2209 stepper_z1]
uart_pin: PB5
run_current: 0.65
stealthchop_threshold: 0

## Motor5
[stepper_z2]
step_pin: PG13
dir_pin: !PG12
enable_pin: !PG15
microsteps: 32
rotation_distance: 4

## Motor5
[tmc2209 stepper_z2]
uart_pin: PG14
run_current: 0.65
stealthchop_threshold: 0

#####################################################################
#                          Bed Heater                               #
#####################################################################

[heater_bed]
heater_pin: PA1
sensor_pin: PB1 
sensor_type: Generic 3950
max_power: 0.6
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#             Homing and Gantry Adjustment Routines                 #
#####################################################################

[z_tilt]

z_positions:
   -50, 18
   175, 398
   400, 18
points:
   30, 5
   175, 295
   320, 5

speed: 200
horizontal_move_z: 5
retries: 5
retry_tolerance: 0.0095

[safe_z_home]

home_xy_position: 175,175
speed:100
z_hop:10

#####################################################################
#                       Probe and Bed Mesh                          #
#####################################################################

[bed_mesh]
speed: 500
horizontal_move_z: 10
probe_count: 20,20
fade_start: 1
fade_end: 10
fade_target: 0
split_delta_z: .01
move_check_distance: 3
mesh_pps: 2,2
algorithm: bicubic
mesh_min: 30,25
mesh_max: 320,325
zero_reference_position: 175,175

#####################################################################
#                            LED Control                            #
#####################################################################

## DayLight Stick
[output_pin caselight]
pin: PA3
pwm:true
hardware_pwm: False
value: 0.20 
shutdown_value: 0
value:0.0
cycle_time: 0.01

[neopixel Manta_Neo]
pin: PD15
chain_count: 8
color_order: GRBW
initial_RED: 0.2
initial_GREEN: 0.2 
initial_BLUE: 0
initial_White: 0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# pid_kp = 28.721
#*# pid_ki = 3.613
#*# pid_kd = 57.082
#*# control = pid
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 41.855
#*# pid_ki = 1.304
#*# pid_kd = 335.883
#*#
#*# [cartographer model default]
#*# model_coef = 1.4343222546392214,
#*# 	  1.8572548171791756,
#*# 	  0.768939290790765,
#*# 	  0.3732796473211778,
#*# 	  0.26089451906441596,
#*# 	  0.20481540097520298,
#*# 	  -0.04606379771284246,
#*# 	  -0.07651605216142382,
#*# 	  0.13416937160145467,
#*# 	  0.09530849845613915
#*# model_domain = 3.18182621049226e-07,3.2853986125114556e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 43.934923
#*# model_offset = 0.27000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.031343, 0.023158, 0.024924, 0.017256, 0.039502, 0.046804, 0.050154, 0.073106, 0.070824, 0.067559, 0.073632, 0.086414, 0.094849, 0.083398, 0.078375, 0.075369, 0.050498, 0.058103, 0.034536, 0.031785
#*# 	  0.019570, 0.020760, 0.030939, 0.036719, 0.063884, 0.038973, 0.057279, 0.067887, 0.077239, 0.100163, 0.088930, 0.094800, 0.071390, 0.087549, 0.095660, 0.073013, 0.061124, 0.051254, 0.031589, 0.002378
#*# 	  0.002164, 0.024117, 0.045454, 0.041691, 0.042347, 0.053087, 0.069033, 0.089807, 0.095244, 0.093343, 0.096060, 0.088891, 0.080791, 0.102060, 0.086151, 0.077640, 0.063145, 0.053082, 0.026326, 0.019448
#*# 	  0.016849, 0.019638, 0.029195, 0.025130, 0.052183, 0.060841, 0.066318, 0.075667, 0.084128, 0.106034, 0.080468, 0.090083, 0.078655, 0.075092, 0.083652, 0.062419, 0.035507, 0.016028, 0.010240, -0.028552
#*# 	  0.015008, 0.031961, 0.034395, 0.053706, 0.055515, 0.049427, 0.069788, 0.077335, 0.094791, 0.093394, 0.092615, 0.080484, 0.079453, 0.076936, 0.064649, 0.051025, 0.032661, 0.009643, 0.007384, -0.023167
#*# 	  0.018022, 0.018714, 0.014264, 0.032494, 0.041680, 0.049617, 0.053218, 0.061612, 0.067594, 0.073052, 0.074062, 0.071048, 0.062796, 0.051748, 0.026240, 0.024843, 0.012842, -0.004271, -0.010146, -0.060377
#*# 	  -0.021244, -0.006327, -0.003878, 0.016577, 0.000534, 0.000778, 0.015532, 0.022963, 0.036036, 0.040153, 0.020691, 0.022211, 0.012643, -0.001350, -0.002637, -0.032939, -0.042808, -0.052320, -0.076588, -0.097052
#*# 	  -0.011779, -0.019171, -0.012208, -0.009167, -0.001891, -0.002973, -0.011904, 0.015076, 0.003763, 0.015559, 0.008209, -0.015073, -0.009240, -0.036211, -0.043554, -0.060781, -0.089732, -0.092088, -0.089109, -0.136190
#*# 	  -0.025883, -0.023235, -0.012535, -0.008975, -0.004600, 0.004862, -0.010884, 0.002644, 0.002912, 0.010085, 0.015702, -0.008056, -0.023040, -0.039290, -0.050991, -0.064215, -0.086415, -0.097957, -0.107367, -0.125842
#*# 	  -0.000485, -0.007999, -0.004395, -0.000887, 0.006420, 0.006403, 0.020370, 0.012040, 0.007934, 0.011494, -0.000459, 0.006481, -0.014844, -0.029843, -0.044884, -0.067810, -0.067859, -0.094902, -0.101860, -0.133916
#*# 	  0.000679, 0.013376, 0.005402, 0.015997, 0.020727, 0.018581, 0.029079, 0.015755, 0.022443, 0.019422, 0.021418, 0.011588, -0.008195, -0.018511, -0.035361, -0.046749, -0.063917, -0.078388, -0.086063, -0.104216
#*# 	  0.013603, -0.004944, 0.005156, 0.009842, 0.021765, 0.012604, 0.012340, 0.007485, 0.017025, 0.017910, 0.009228, 0.003431, -0.008655, -0.023520, -0.045261, -0.050115, -0.063265, -0.078097, -0.088410, -0.114959
#*# 	  0.015232, 0.019954, 0.009881, 0.021796, 0.017145, 0.017065, 0.020581, 0.025448, 0.023493, 0.018380, 0.010868, 0.003085, -0.002059, -0.010650, -0.030531, -0.039039, -0.052742, -0.066842, -0.070788, -0.090091
#*# 	  0.041259, 0.020929, 0.019893, 0.025192, 0.024380, 0.022230, 0.018804, 0.029695, 0.035112, 0.024956, 0.015579, 0.001143, 0.002642, -0.002661, -0.013575, -0.031182, -0.046776, -0.069652, -0.064844, -0.097539
#*# 	  0.019476, 0.016863, 0.009920, 0.009851, 0.015236, 0.007744, 0.005062, 0.014229, 0.013009, 0.014606, 0.004331, -0.007023, -0.013897, -0.025173, -0.029969, -0.052109, -0.068147, -0.087711, -0.091102, -0.100090
#*# 	  0.022738, 0.013950, 0.009953, 0.004447, 0.001927, 0.001583, 0.002981, 0.010846, 0.005225, 0.000779, -0.007962, -0.013269, -0.016337, -0.033822, -0.047368, -0.069626, -0.084593, -0.098437, -0.101209, -0.124472
#*# 	  0.012011, 0.011966, 0.005274, 0.007740, 0.014865, 0.008289, 0.006270, 0.004696, 0.003277, -0.000060, -0.004397, -0.013483, -0.028763, -0.039516, -0.049034, -0.062549, -0.083179, -0.099472, -0.104739, -0.114743
#*# 	  0.026630, 0.022684, 0.012986, 0.007777, 0.013142, 0.010366, 0.007791, 0.010010, 0.005723, 0.001927, -0.003380, -0.000867, -0.013198, -0.025544, -0.037278, -0.058081, -0.075018, -0.087922, -0.096270, -0.113740
#*# 	  0.041367, 0.047256, 0.039400, 0.027935, 0.045762, 0.034268, 0.034400, 0.031102, 0.041764, 0.027162, 0.026178, 0.023721, 0.013517, -0.005390, -0.019492, -0.035522, -0.050529, -0.067155, -0.069246, -0.074999
#*# 	  -0.004332, 0.000241, -0.005138, -0.000255, -0.000949, 0.003519, 0.003019, -0.004658, -0.005995, -0.002801, -0.020267, -0.023022, -0.033792, -0.051715, -0.062539, -0.070754, -0.075822, -0.084271, -0.092129, -0.103826
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 320.0
#*# min_y = 25.0
#*# max_y = 325.0
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 74.4
#*# shaper_type_y = mzv
#*# shaper_freq_y = 50.4
