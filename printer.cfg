# This file contains common pin mappings for the BIGTREETECH Manta M8P V2.0
# To use this config, the firmware should be compiled for the
# STM32H723 with a "128KiB bootloader" "25 MHz crystal"
# and "USB (on PA11/PA12)", "CAN bus (on PD0/PD1)" or Serial (on USART1 PA10/PA9).

# See docs/Config_Reference.md for a description of parameters.

####################################################################
#                        KLIPPER CONFIGS                           #
####################################################################
[include aux_fan.cfg]
[include mainsail.cfg]
[include timelapse.cfg]
[include macros.cfg]
[include BTT_2209.cfg]
[include config_backup.cfg]
[include cartographer.cfg]
[include stealthburner_leds.cfg] 
[include nevermore.cfg]  
#[include mmu/base/*.cfg]
#[include mmu/optional/client_macros.cfg]
#[include mmu/optional/client/macros*.cfg]

[exclude_object]

[force_move]
enable_force_move: True

[gcode_arcs]
resolution: 0.1

####################################################################
#                        Manta MP8 CONFIGS                         #
####################################################################

[mcu]
canbus_uuid: 85562c707f72
canbus_interface: can0

[printer]
kinematics: corexy
max_velocity: 6000 
max_accel: 10000
max_z_velocity: 25        
max_z_accel: 60
minimum_cruise_ratio: 0.5             # Default 0.5
square_corner_velocity: 5             # Square corner velocity

[firmware_retraction]
retract_length: 0.75
retract_speed: 30
unretract_extra_length: 0.00
unretract_speed: 30

####################################################################
#                TEMPERATURE SENSORS & FAN CONTROL                 #
####################################################################

[temperature_sensor CB2]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_fan Electronics_Bay_1]
pin: PF7
kick_start_time: 0.5
shutdown_speed: 0
off_below: 0.1
max_power: 0.65
sensor_type: temperature_host
control: pid
min_temp: -40
max_temp: 85
pid_kp: 1.0
pid_ki: 0.5
pid_kd: 2.0
min_speed: 0.4
max_speed: 1.0
target_temp: 42

[temperature_fan Electronics_Bay_2]
pin: PF9
kick_start_time: 0.5
shutdown_speed: 0
off_below: 0.1
max_power: 0.65
sensor_type: temperature_host
control: pid
min_temp: -40
max_temp: 85
pid_kp: 1.0
pid_ki: 0.5
pid_kd: 2.0
min_speed: 0.4
max_speed: 1.0
target_temp: 42

[temperature_fan Manta_MP8]
pin: PF8
sensor_type: temperature_mcu
max_power: 1.0
shutdown_speed: 1.0
hardware_pwm: false
kick_start_time: 0.5
off_below: 0.1
max_temp: 100
min_temp: 5
target_temp: 42
max_speed: 1.0
min_speed: 0.3
control: pid
pid_Kp: 1.0
pid_Ki: 0.5
pid_Kd: 2.0

#####################################################################
#                       ADXL345 Settings                            #
#####################################################################

## Ebb 2209 2040 Sensor
[adxl345]
cs_pin: EBBCan: PB12
spi_software_sclk_pin: EBBCan: PB10
spi_software_mosi_pin: EBBCan: PB11
spi_software_miso_pin: EBBCan: PB2
axes_map: z,-y,x

[resonance_tester]
probe_points: 175, 175, 30
accel_chip: adxl345

## Cartographer Probe Sensor
#[lis2dw]
#cs_pin: cartographer:PA3
#spi_bus: spi1

#[resonance_tester]
#probe_points: 175, 175, 30
#accel_chip: lis2dw

#####################################################################
#                        X Stepper Settings                         #
#####################################################################

## Motor1
[stepper_x]
step_pin: PE6
dir_pin: !PE5
enable_pin: !PC14
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40
endstop_pin: ^EBBCan:PB6
position_endstop: 350
position_max: 350
homing_speed: 80
homing_positive_dir: True

## Motor1
[tmc5160 stepper_x]
cs_pin: PC13
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
run_current: 1.0
stealthchop_threshold: 0
spi_speed: 3500000                    # SPI speed
interpolate: False                     # Interpolation

## Motor7
[stepper_x1]
step_pin: PD4
dir_pin: !PD3
enable_pin: !PD6
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40

## Motor7
[tmc5160 stepper_x1]
cs_pin: PD5
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
run_current: 1.0
stealthchop_threshold: 0
spi_speed: 3500000                    # SPI speed
interpolate: False                     # Interpolation

#####################################################################
#                        Y Stepper Settings                         #
#####################################################################

## Motor8
[stepper_y]
step_pin: PC7
dir_pin: !PC8
enable_pin: !PD2
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40
endstop_pin: ^PF4
position_endstop: 350
position_max: 350
homing_speed: 80
homing_positive_dir: True

## Motor8
[tmc5160 stepper_y]
cs_pin: PC6
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
run_current: 1.0
stealthchop_threshold: 0
spi_speed: 3500000                    # SPI speed
interpolate: False                     # Interpolation

## Motor2
[stepper_y1]
step_pin: PE2
dir_pin: !PE1
enable_pin: !PE4
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40

## Motor2
[tmc5160 stepper_y1]
cs_pin: PE3
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
run_current: 1.0
stealthchop_threshold: 0
spi_speed: 3500000                    # SPI speed
interpolate: False                     # Interpolation

#####################################################################
##                        Z Stepper Settings                        #
#####################################################################

#    -------z1------- 
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#  z0---   display ---z2

## Motor3
[stepper_z]
step_pin: PB8
dir_pin: !PB7
enable_pin: !PE0
rotation_distance: 4    
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop 
position_max: 243
position_min: -.5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 0
homing_positive_dir: False

## Motor3
[tmc2209 stepper_z]
uart_pin: PB9
run_current: 0.65
stealthchop_threshold: 0

## Motor4
[stepper_z1]
step_pin: PB4
dir_pin: !PB3
enable_pin: !PB6
microsteps: 32
rotation_distance: 4

## Motor4
[tmc2209 stepper_z1]
uart_pin: PB5
run_current: 0.65
stealthchop_threshold: 0

## Motor5
[stepper_z2]
step_pin: PG13
dir_pin: !PG12
enable_pin: !PG15
microsteps: 32
rotation_distance: 4

## Motor5
[tmc2209 stepper_z2]
uart_pin: PG14
run_current: 0.65
stealthchop_threshold: 0

#####################################################################
#                          Bed Heater                               #
#####################################################################

[idle_timeout]
timeout: 1800

[heater_bed]
heater_pin: PA1
sensor_pin: PB1 
sensor_type: Generic 3950
max_power: 0.6
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#             Homing and Gantry Adjustment Routines                 #
#####################################################################

[z_tilt]

z_positions:
   -50, 18
   175, 398
   400, 18
points:
   30, 5
   175, 295
   320, 5

speed: 200
horizontal_move_z: 5
retries: 5
retry_tolerance: 0.0095

[safe_z_home]

home_xy_position: 175,175
speed:100
z_hop:10

#####################################################################
#                       Probe and Bed Mesh                          #
#####################################################################

[bed_mesh]
speed: 500
horizontal_move_z: 10
probe_count: 20,20
fade_start: 1
fade_end: 10
fade_target: 0
split_delta_z: .01
move_check_distance: 3
mesh_pps: 2,2
algorithm: bicubic
mesh_min: 30,25
mesh_max: 320,325
zero_reference_position: 175,175

#####################################################################
#                            LED Control                            #
#####################################################################

## DayLight Stick
[output_pin caselight]
pin: PA3
pwm:true
hardware_pwm: False
value: 0.20 
shutdown_value: 0
value:0.40
cycle_time: 0.01

[neopixel Manta_Neo]
pin: PD15
chain_count: 8
color_order: GRBW
initial_RED: 0.2
initial_GREEN: 0.2 
initial_BLUE: 0
initial_White: 0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# pid_kp = 28.721
#*# pid_ki = 3.613
#*# pid_kd = 57.082
#*# control = pid
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 41.855
#*# pid_ki = 1.304
#*# pid_kd = 335.883
#*#
#*# [cartographer model default]
#*# model_coef = 1.4343222546392214,
#*# 	1.8572548171791756,
#*# 	0.768939290790765,
#*# 	0.3732796473211778,
#*# 	0.26089451906441596,
#*# 	0.20481540097520298,
#*# 	-0.04606379771284246,
#*# 	-0.07651605216142382,
#*# 	0.13416937160145467,
#*# 	0.09530849845613915
#*# model_domain = 3.18182621049226e-07,3.2853986125114556e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 43.934923
#*# model_offset = 0.37000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.045178, 0.047518, 0.042837, 0.045723, 0.050760, 0.054070, 0.057127, 0.062716, 0.070491, 0.077379, 0.082920, 0.089714, 0.083399, 0.082913, 0.080741, 0.079900, 0.075262, 0.066113, 0.052253, 0.047911
#*# 	0.047996, 0.046640, 0.047539, 0.050208, 0.056972, 0.058188, 0.062210, 0.067620, 0.075102, 0.084426, 0.089153, 0.093423, 0.086334, 0.086143, 0.078336, 0.078753, 0.074445, 0.063313, 0.051041, 0.030824
#*# 	0.028836, 0.046579, 0.049672, 0.054618, 0.064217, 0.067370, 0.070494, 0.075695, 0.082929, 0.089041, 0.093341, 0.097721, 0.091138, 0.090900, 0.084741, 0.079496, 0.067980, 0.060253, 0.042879, 0.029838
#*# 	0.040489, 0.039316, 0.045213, 0.049404, 0.057246, 0.063740, 0.066092, 0.073179, 0.076646, 0.085427, 0.087373, 0.086167, 0.079932, 0.073795, 0.067431, 0.062706, 0.049878, 0.036484, 0.020510, -0.002927
#*# 	0.037449, 0.050518, 0.049789, 0.048421, 0.059039, 0.062774, 0.068577, 0.073631, 0.077196, 0.083404, 0.081137, 0.078653, 0.070840, 0.066856, 0.057358, 0.046546, 0.032593, 0.020173, -0.000081, -0.015408
#*# 	0.041592, 0.039082, 0.042212, 0.045210, 0.047218, 0.049637, 0.051785, 0.058082, 0.060777, 0.061157, 0.061617, 0.059902, 0.050608, 0.041172, 0.030353, 0.017875, 0.009024, -0.003949, -0.024025, -0.049511
#*# 	0.009212, 0.019273, 0.017050, 0.016129, 0.020583, 0.018486, 0.017395, 0.021512, 0.023037, 0.021026, 0.018416, 0.015712, 0.004708, -0.007518, -0.014445, -0.025563, -0.042658, -0.050529, -0.069188, -0.090974
#*# 	0.009512, 0.006336, 0.005601, 0.005477, 0.005687, 0.004995, 0.004040, 0.005748, 0.003689, 0.000551, -0.004548, -0.015628, -0.019249, -0.036547, -0.042080, -0.060007, -0.073415, -0.087362, -0.098206, -0.126371
#*# 	0.004435, 0.003881, 0.003293, 0.004260, 0.004461, 0.003446, 0.000832, 0.005857, 0.011370, -0.002640, -0.007951, -0.016250, -0.025789, -0.041467, -0.051903, -0.067197, -0.083034, -0.095525, -0.107478, -0.121988
#*# 	0.020903, 0.007749, 0.009508, 0.011377, 0.012649, 0.010009, 0.011368, 0.015270, 0.015770, 0.001333, -0.006901, -0.004784, -0.019475, -0.036434, -0.051604, -0.067259, -0.081867, -0.096616, -0.103232, -0.129435
#*# 	0.024466, 0.024838, 0.022647, 0.024399, 0.024632, 0.020321, 0.018939, 0.022617, 0.022068, 0.009382, 0.003286, -0.000156, -0.010820, -0.029693, -0.043029, -0.057471, -0.073653, -0.085370, -0.094626, -0.108649
#*# 	0.031850, 0.022036, 0.020137, 0.019885, 0.018395, 0.017026, 0.012960, 0.015747, 0.018118, 0.003016, -0.004543, -0.004872, -0.013479, -0.034872, -0.049685, -0.062058, -0.074383, -0.090557, -0.097570, -0.122147
#*# 	0.032620, 0.033677, 0.026452, 0.023104, 0.024090, 0.020763, 0.020191, 0.022858, 0.020443, 0.009381, -0.002179, -0.010359, -0.014275, -0.030768, -0.042790, -0.051148, -0.066990, -0.080607, -0.091362, -0.104430
#*# 	0.060753, 0.040296, 0.034582, 0.029273, 0.030007, 0.026662, 0.023192, 0.028566, 0.023522, 0.016684, 0.002061, -0.001622, -0.008986, -0.020546, -0.031472, -0.045760, -0.059498, -0.078822, -0.088717, -0.111044
#*# 	0.047803, 0.041729, 0.029192, 0.022488, 0.021934, 0.017396, 0.015901, 0.018143, 0.015302, 0.011554, 0.001754, -0.007256, -0.014106, -0.029299, -0.041946, -0.055247, -0.078215, -0.091094, -0.104098, -0.111985
#*# 	0.057253, 0.037151, 0.027372, 0.024340, 0.023610, 0.018281, 0.017527, 0.016665, 0.013215, 0.008304, -0.001158, -0.009538, -0.019488, -0.034885, -0.047038, -0.065958, -0.085153, -0.103671, -0.111047, -0.132508
#*# 	0.051900, 0.047326, 0.033412, 0.031405, 0.030384, 0.026791, 0.022825, 0.023650, 0.018055, 0.010580, 0.001867, -0.005402, -0.016798, -0.029711, -0.045274, -0.063109, -0.084363, -0.099783, -0.109569, -0.119874
#*# 	0.068438, 0.050854, 0.041482, 0.041373, 0.040571, 0.035231, 0.029075, 0.031064, 0.025483, 0.016528, 0.013187, 0.005838, -0.000596, -0.017131, -0.029608, -0.051652, -0.073481, -0.089484, -0.100591, -0.120636
#*# 	0.087804, 0.088783, 0.077814, 0.073239, 0.071386, 0.066608, 0.061891, 0.059544, 0.058167, 0.051092, 0.044149, 0.041165, 0.029070, 0.009188, -0.008477, -0.023949, -0.048575, -0.061334, -0.072409, -0.079675
#*# 	0.042983, 0.036611, 0.037815, 0.035942, 0.033592, 0.024605, 0.028375, 0.028200, 0.022333, 0.008165, -0.000584, -0.007269, -0.016743, -0.043205, -0.063923, -0.075013, -0.078401, -0.096399, -0.106762, -0.120000
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 320.0
#*# min_y = 25.0
#*# max_y = 325.0
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 65.4
#*# shaper_type_y = mzv
#*# shaper_freq_y = 51.4
