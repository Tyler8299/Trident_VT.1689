# This file contains common pin mappings for the BIGTREETECH Manta M8P V2.0
# To use this config, the firmware should be compiled for the
# STM32H723 with a "128KiB bootloader" "25 MHz crystal"
# and "USB (on PA11/PA12)", "CAN bus (on PD0/PD1)" or Serial (on USART1 PA10/PA9).

# See docs/Config_Reference.md for a description of parameters.

####################################################################
#                        KLIPPER CONFIGS                           #
####################################################################
[include aux_fan.cfg]
[include mainsail.cfg]
[include timelapse.cfg]
[include macros.cfg]
[include BTT_2209.cfg]
[include config_backup.cfg]
[include cartographer.cfg]
[include stealthburner_leds.cfg] 
[include nevermore.cfg]  
#[include mmu/base/*.cfg]
#[include mmu/optional/client_macros.cfg]
#[include mmu/optional/client/macros*.cfg]

[exclude_object]

[force_move]
enable_force_move: True

[gcode_arcs]
resolution: 0.1

####################################################################
#                        Manta MP8 CONFIGS                         #
####################################################################

[mcu]
canbus_uuid: 85562c707f72
canbus_interface: can0

[printer]
kinematics: corexy
max_velocity: 6000 
max_accel: 12000
max_z_velocity: 25        
max_z_accel: 60
minimum_cruise_ratio: 0.5             # Default 0.5
square_corner_velocity: 25            # Square corner velocity

[firmware_retraction]
retract_length: 0.75
retract_speed: 30
unretract_extra_length: 0.00
unretract_speed: 30

####################################################################
#                TEMPERATURE SENSORS & FAN CONTROL                 #
####################################################################

[temperature_sensor CB2]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_fan Electronics_Bay]
pin: PF7
kick_start_time: 0.5
shutdown_speed: 0
off_below: 0.1
max_power: 1.0
sensor_type: temperature_host
control: pid
min_temp: -40
max_temp: 85
pid_kp: 1.0
pid_ki: 0.5
pid_kd: 2.0
min_speed: 0.4
max_speed: 1.0
target_temp: 42

[temperature_fan Manta_MP8]
pin: PF8
sensor_type: temperature_mcu
max_power: 1.0
shutdown_speed: 1.0
hardware_pwm: false
kick_start_time: 0.5
off_below: 0.1
max_temp: 100
min_temp: 5
target_temp: 42
max_speed: 1.0
min_speed: 0.3
control: pid
pid_Kp: 1.0
pid_Ki: 0.5
pid_Kd: 2.0

#[fan_generic Nevermore_1]
#pin: PF9
#kick_start_time: 0.5
#off_below: 0.10

#[fan_generic Nevermore_2]
#pin: PF6
#kick_start_time: 0.5
#off_below: 0.10

#####################################################################
#                       ADXL345 Settings                            #
#####################################################################

## Ebb 2209 2040 Sensor
[adxl345]
cs_pin: EBBCan: PB12
spi_software_sclk_pin: EBBCan: PB10
spi_software_mosi_pin: EBBCan: PB11
spi_software_miso_pin: EBBCan: PB2
axes_map: z,-y,x

[resonance_tester]
probe_points: 175, 175, 30
accel_chip: adxl345

## Cartographer Probe Sensor
#[lis2dw]
#cs_pin: cartographer:PA3
#spi_bus: spi1

#[resonance_tester]
#probe_points: 175, 175, 30
#accel_chip: lis2dw

#####################################################################
#                        X Stepper Settings                         #
#####################################################################

## Motor1
[stepper_x]
step_pin: PE6
dir_pin: !PE5
enable_pin: !PC14
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40
endstop_pin: ^EBBCan:PB6
position_endstop: 350
position_max: 350
homing_speed: 80
homing_positive_dir: True

## Motor1
[tmc5160 stepper_x]
cs_pin: PC13
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
run_current: 0.85
stealthchop_threshold: 0
spi_speed: 3500000                    # SPI speed
interpolate: False                     # Interpolation

## Motor7
[stepper_x1]
step_pin: PD4
dir_pin: !PD3
enable_pin: !PD6
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40

## Motor7
[tmc5160 stepper_x1]
cs_pin: PD5
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
run_current: 0.85
stealthchop_threshold: 0
spi_speed: 3500000                    # SPI speed
interpolate: False                     # Interpolation

#####################################################################
#                        Y Stepper Settings                         #
#####################################################################

## Motor8
[stepper_y]
step_pin: PC7
dir_pin: !PC8
enable_pin: !PD2
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40
endstop_pin: ^PF4
position_endstop: 350
position_max: 350
homing_speed: 80
homing_positive_dir: True

## Motor8
[tmc5160 stepper_y]
cs_pin: PC6
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
run_current: 0.85
stealthchop_threshold: 0
spi_speed: 3500000                    # SPI speed
interpolate: False                     # Interpolation

## Motor2
[stepper_y1]
step_pin: PE2
dir_pin: !PE1
enable_pin: !PE4
microsteps: 32
full_steps_per_rotation:200
rotation_distance: 40

## Motor2
[tmc5160 stepper_y1]
cs_pin: PE3
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
run_current: 0.85
stealthchop_threshold: 0
spi_speed: 3500000                    # SPI speed
interpolate: False                     # Interpolation

#####################################################################
##                        Z Stepper Settings                        #
#####################################################################

#    -------z1------- 
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#  z0---   display ---z2

## Motor3
[stepper_z]
step_pin: PB8
dir_pin: !PB7
enable_pin: !PE0
rotation_distance: 4    
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop 
position_max: 243
position_min: -.5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 0
homing_positive_dir: False

## Motor3
[tmc2209 stepper_z]
uart_pin: PB9
run_current: 0.65
stealthchop_threshold: 0

## Motor4
[stepper_z1]
step_pin: PB4
dir_pin: !PB3
enable_pin: !PB6
microsteps: 32
rotation_distance: 4

## Motor4
[tmc2209 stepper_z1]
uart_pin: PB5
run_current: 0.65
stealthchop_threshold: 0

## Motor5
[stepper_z2]
step_pin: PG13
dir_pin: !PG12
enable_pin: !PG15
microsteps: 32
rotation_distance: 4

## Motor5
[tmc2209 stepper_z2]
uart_pin: PG14
run_current: 0.65
stealthchop_threshold: 0

#####################################################################
#                          Bed Heater                               #
#####################################################################

[heater_bed]
heater_pin: PA1
sensor_pin: PB1 
sensor_type: Generic 3950
max_power: 0.6
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#             Homing and Gantry Adjustment Routines                 #
#####################################################################

[z_tilt]

z_positions:
   -50, 18
   175, 398
   400, 18
points:
   30, 5
   175, 295
   320, 5

speed: 200
horizontal_move_z: 5
retries: 5
retry_tolerance: 0.0095

[safe_z_home]

home_xy_position: 175,175
speed:100
z_hop:10

#####################################################################
#                       Probe and Bed Mesh                          #
#####################################################################

[bed_mesh]
speed: 500
horizontal_move_z: 10
probe_count: 20,20
fade_start: 1
fade_end: 10
fade_target: 0
split_delta_z: .01
move_check_distance: 3
mesh_pps: 2,2
algorithm: bicubic
mesh_min: 30,25
mesh_max: 320,325
zero_reference_position: 175,175

#####################################################################
#                            LED Control                            #
#####################################################################

## DayLight Stick
[output_pin caselight]
pin: PA3
pwm:true
hardware_pwm: False
value: 0.20 
shutdown_value: 0
value:0.0
cycle_time: 0.01

[neopixel Manta_Neo]
pin: PD15
chain_count: 8
color_order: GRBW
initial_RED: 0.2
initial_GREEN: 0.2 
initial_BLUE: 0
initial_White: 0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# pid_kp = 28.721
#*# pid_ki = 3.613
#*# pid_kd = 57.082
#*# control = pid
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 41.855
#*# pid_ki = 1.304
#*# pid_kd = 335.883
#*#
#*# [cartographer model default]
#*# model_coef = 1.4343222546392214,
#*# 	  1.8572548171791756,
#*# 	  0.768939290790765,
#*# 	  0.3732796473211778,
#*# 	  0.26089451906441596,
#*# 	  0.20481540097520298,
#*# 	  -0.04606379771284246,
#*# 	  -0.07651605216142382,
#*# 	  0.13416937160145467,
#*# 	  0.09530849845613915
#*# model_domain = 3.18182621049226e-07,3.2853986125114556e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 43.934923
#*# model_offset = 0.23000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.002803, -0.003346, -0.000064, 0.014847, 0.013902, 0.012626, 0.022846, 0.032666, 0.045702, 0.049565, 0.052720, 0.060885, 0.056235, 0.057597, 0.050806, 0.044317, 0.038345, 0.030261, 0.011195, -0.003975
#*# 	  -0.005831, -0.003861, -0.000549, 0.017755, 0.027580, 0.027991, 0.021804, 0.033083, 0.057905, 0.064593, 0.063362, 0.068539, 0.053434, 0.060211, 0.058282, 0.045592, 0.034157, 0.015735, 0.004185, -0.026304
#*# 	  -0.021261, -0.001135, 0.006573, 0.020397, 0.028562, 0.030987, 0.043153, 0.052720, 0.060259, 0.065129, 0.066857, 0.073884, 0.067205, 0.071215, 0.055715, 0.042706, 0.034311, 0.023958, 0.004352, -0.020266
#*# 	  -0.007108, -0.009559, 0.004394, 0.016698, 0.025140, 0.036423, 0.034497, 0.044519, 0.065985, 0.064692, 0.069748, 0.063011, 0.055496, 0.064449, 0.041501, 0.033726, 0.021230, -0.004617, -0.019420, -0.052854
#*# 	  -0.005539, 0.008129, 0.011685, 0.022314, 0.032398, 0.032424, 0.049123, 0.057917, 0.064603, 0.068955, 0.064745, 0.065993, 0.058670, 0.048981, 0.038717, 0.022487, 0.005716, -0.008378, -0.027343, -0.055065
#*# 	  -0.003332, -0.009022, 0.004488, 0.015551, 0.019892, 0.027494, 0.023968, 0.039945, 0.053402, 0.049148, 0.050374, 0.040709, 0.041782, 0.035390, 0.013265, -0.000383, -0.018103, -0.033219, -0.047191, -0.091675
#*# 	  -0.045470, -0.030562, -0.027200, -0.022486, -0.009297, -0.020598, -0.007755, -0.000069, 0.005278, 0.009274, 0.005319, -0.001699, -0.004810, -0.015319, -0.025283, -0.043116, -0.067490, -0.074879, -0.097678, -0.126425
#*# 	  -0.042218, -0.043975, -0.034323, -0.036948, -0.029917, -0.033346, -0.024890, -0.006086, -0.012277, -0.011848, -0.010998, -0.025995, -0.021927, -0.040357, -0.051434, -0.068462, -0.093753, -0.105820, -0.114025, -0.160793
#*# 	  -0.048794, -0.044848, -0.038951, -0.033804, -0.030883, -0.024222, -0.027949, -0.014844, -0.012856, -0.010600, -0.006010, -0.024119, -0.028998, -0.042884, -0.056328, -0.072176, -0.093162, -0.110622, -0.129407, -0.150929
#*# 	  -0.027795, -0.026706, -0.028182, -0.027840, -0.021232, -0.022987, -0.010728, -0.006370, -0.004998, 0.000320, -0.002336, -0.003457, -0.021013, -0.036171, -0.050902, -0.069776, -0.079798, -0.109178, -0.121557, -0.157962
#*# 	  -0.022955, -0.011629, -0.012802, -0.006781, -0.002213, -0.004029, 0.000385, 0.004010, 0.005739, 0.014106, 0.016341, 0.005897, -0.007026, -0.027659, -0.040963, -0.055470, -0.068031, -0.088705, -0.106502, -0.130623
#*# 	  -0.008068, -0.018048, -0.014844, -0.013508, -0.010096, -0.003722, -0.005924, 0.001972, 0.005078, 0.000564, 0.005222, -0.002438, -0.011549, -0.030030, -0.049502, -0.060315, -0.072161, -0.097913, -0.112123, -0.143339
#*# 	  -0.010004, 0.002843, -0.009146, -0.008798, 0.002520, 0.003056, 0.008698, 0.019029, 0.013928, 0.009636, 0.007504, 0.003947, -0.003043, -0.025452, -0.033709, -0.050955, -0.074667, -0.084191, -0.107223, -0.122075
#*# 	  0.020783, 0.007046, 0.002498, -0.000658, 0.018518, 0.017513, 0.017536, 0.025061, 0.021213, 0.025619, 0.016443, 0.007668, -0.005110, -0.020710, -0.029097, -0.053028, -0.070278, -0.091064, -0.104894, -0.129723
#*# 	  -0.001267, 0.003644, -0.007804, -0.007048, -0.000209, -0.001251, 0.004209, 0.009460, 0.012222, 0.006470, 0.002471, -0.008374, -0.020456, -0.034598, -0.040164, -0.076506, -0.103047, -0.110865, -0.123897, -0.132022
#*# 	  0.007960, -0.002407, -0.005483, -0.011104, 0.006301, -0.003389, 0.000903, 0.002677, -0.000052, -0.002887, -0.005599, -0.016207, -0.030256, -0.051121, -0.054614, -0.096732, -0.117175, -0.130845, -0.139673, -0.158407
#*# 	  -0.004078, -0.002320, -0.006372, -0.002238, -0.000717, 0.000179, -0.002753, -0.000254, -0.000919, -0.006268, -0.011544, -0.023276, -0.034929, -0.046703, -0.062864, -0.095695, -0.122127, -0.129160, -0.137643, -0.150427
#*# 	  0.015539, 0.006714, 0.001190, 0.007592, 0.005307, 0.001574, 0.000632, 0.000488, 0.000422, -0.006006, -0.011206, -0.017690, -0.023708, -0.036929, -0.048813, -0.090533, -0.115595, -0.118533, -0.131940, -0.152503
#*# 	  0.029883, 0.042976, 0.032332, 0.031917, 0.031498, 0.027798, 0.022597, 0.022364, 0.022125, 0.014524, 0.010695, 0.007681, -0.002653, -0.015797, -0.027555, -0.053050, -0.079537, -0.093137, -0.100238, -0.108566
#*# 	  -0.003149, -0.003311, 0.002614, -0.006180, -0.013860, -0.020687, -0.016514, -0.020620, -0.021738, -0.034367, -0.045439, -0.053558, -0.064068, -0.079348, -0.090360, -0.095307, -0.101871, -0.110983, -0.128928, -0.142588
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 320.0
#*# min_y = 25.0
#*# max_y = 325.0
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 74.4
#*# shaper_type_y = mzv
#*# shaper_freq_y = 50.4
